#!/bin/bash

append() {
    echo "$1" | sudo tee -a $2
}

if [[ -z "$1" || $1 = help ]]; then
    echo "iface scan"
    echo "iface vault [ssid]"
    echo "iface wifi <interface> <ssid> [psk [address/mask gateway]]"
    echo "iface eth <interface> [address/mask gateway]"
    exit
fi

if [ $1 = scan ]; then
    wpa_cli scan
    wpa_cli scan_results
fi

conf=/etc/network/interfaces

if [ $1 = wifi ]; then
    if [[ -z "$2" || -z "$3" ]]; then
        $0 help
        exit 1
    fi
    if [[ -n "$5" && -n "$6" ]]; then
        inet=static
    else
        inet=dhcp
    fi
    sudo rm -f $conf
    append "source /etc/network/interfaces.d/*" $conf
    append "auto lo" $conf
    append "iface lo inet loopback" $conf
    append "iface $2 inet $inet" $conf
    if [ -z "$4" ]; then
        append "    wireless-essid $3" $conf
    elif [ "$4" = "-" ]; then
        psk=$($0 vault "$3" | awk '{print $2}')
        append "    wpa-ssid $3" $conf
        append "    wpa-psk $psk" $conf
    else
        append "    wpa-ssid $3" $conf
        append "    wpa-psk $4" $conf
    fi
    if [ $inet = static ]; then
        append "    address $5" $conf
        append "    gateway $6" $conf
    fi
    sudo ifdown $2
    sudo ifup $2
fi

if [ $1 = eth ]; then
    if [[ -z "$2" ]]; then
        $0 help
        exit 1
    fi
    if [[ -n "$3" && -n "$4" ]]; then
        inet=static
    else
        inet=dhcp
    fi
    sudo rm -f $conf
    append "source /etc/network/interfaces.d/*" $conf
    append "auto lo" $conf
    append "iface lo inet loopback" $conf
    append "iface $2 inet $inet" $conf
    if [ $inet = static ]; then
        append "    address $3" $conf
        append "    gateway $4" $conf
    fi
    sudo ifdown $2
    sudo ifup $2
fi

if [ $1 = vault ]; then
    vault="jA0EBwMCFUQj1VVW7J1g0sAJAXqJhVXtHUlbrWOTyzR83ucdn7Wft98tMnDAFbiM8jXaFSHJN4MPUePz9G6NjDNKP3obSCyZvr/r89Gi2tjDaOMRHCUTTuikY0wJmeRhWZmEBaax0dAhVmv+aVvsgro7p6yklMcEzvad5u3T/2lYASRPLHTh83JoBQMWZVWv61MoJMcwzyXP+0+2hYw9mXnr1Ss1LKWOGOwkuL6PZRtSMa7eXmHX1l8nwSWyQG3kBnB0kxSAlaDtDbjpwv+U7v9MVDBfZ5PKFaFa"
    if [ -z "$2" ]; then
        echo $vault | base64 -d | gpg -d
    else
        echo $vault | base64 -d | gpg -d | grep "^$2::::" | sed -e 's/::::/ /g'
    fi
fi

if [ $1 = ":vault" ]; then
    gpg -c | base64 -w 0
fi
