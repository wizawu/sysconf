---
- hosts: localhost
  remote_user: root

  tasks:
  - name: update ansible config
    lineinfile:
      dest: /etc/ansible/ansible.cfg
      regexp: "{{item.regexp}}"
      line: "{{item.line}}"
      insertafter: '^\[defaults\]'
    with_items:
    - { regexp: '^callback_whitelist\s{0,}=', line: 'callback_whitelist = profile_tasks' }
    - { regexp: '^retry_files_enabled\s{0,}=', line: 'retry_files_enabled = False' }

  - name: create user
    user: name={{user}} state=present group=root shell=/bin/bash

  - name: clone repo
    git: repo=git@github.com:wizawu/sysconf dest=/home/{{user}}/.sysconf force=yes
    become: true
    become_user: "{{user}}"

  - name: locale-gen
    locale_gen: name={{item}} state=present
    with_items:
    - en_US.UTF-8
    - zh_CN
    - zh_CN.GB18030
    - zh_CN.GBK
    - zh_CN.UTF-8

  - name: create symbolic link to apt sources.list
    file: src=/home/{{user}}/.sysconf/{{item}} dest=/{{item}} state=link force=yes
    with_items:
    - etc/apt/sources.list

  - name: add apt keys
    apt_key: keyserver=keyserver.ubuntu.com id={{item}}
    with_items:
    - 1655A0AB68576280      # node
    - 7638D0442B90D010      # debian
    - EB3E94ADBE1229CF      # vscode
    - F1656F24C74CD1D8      # mariadb

  - name: install apt packages
    apt:
      update_cache: no
      install_recommends: no
      autoclean: yes
      name:
      - ack-grep
      - acpi
      - alsa-oss
      - alsa-tools
      - alsa-utils
      - apache2-utils
      - autossh
      - awesome
      - awesome-extra
      - bash-completion
      - caja
      - cifs-utils
      - clang-format
      - cmake
      - code
      - colortail
      - debootstrap
      - deepin-screenshot
      - di
      - dnsutils
      - dstat
      - entr
      - fcitx
      - fcitx-frontend-gtk3
      - fcitx-googlepinyin
      - fcitx-ui-classic
      - fio
      - firefox
      - fiu-utils
      - fontforge
      - fping
      - g++
      - gcc-doc
      - gimp
      - git-lfs
      - google-chrome-stable
      - google-perftools
      - gufw
      - hdparm
      - hsetroot
      - htop
      - httpie
      - httrack
      - iftop
      - im-config
      - inkscape
      - iotop
      - less
      - lftp
      - linux-headers-amd64
      - linux-image-amd64
      - lm-sensors
      - locate
      - lshw
      - lsof
      - m4
      - make
      - manpages-dev
      - mariadb-server
      - mate-desktop
      - mate-desktop-environment-core
      - mate-settings-daemon
      - mtr
      - mupdf
      - mycli
      - netcat
      - nginx
      - nmap
      - nethogs
      - nodejs
      - ntfs-3g
      - ntpdate
      - p7zip-full
      - parallel
      - pluma
      - pm-utils
      - pppoeconf
      - psmisc
      - pulseaudio
      - qbittorrent
      - redis-server
      - rinetd
      - rlwrap
      - rsync
      - rxvt-unicode-256color
      - samba
      - smbclient
      - smplayer
      - ssh
      - sshfs
      - sshpass
      - strace
      - sudo
      - supervisor
      - sysbench
      - syslog-ng
      - sysstat
      - systemd-sysv
      - tcpdump
      - time
      - tlp
      - tlp-rdw
      - tmux
      - tree
      - tsocks
      - unrar
      - unzip
      - upower
      - valgrind
      - viewnior
      - vifm
      - vim-gtk
      - vsftpd
      - whois
      - wicd-gtk
      - wpasupplicant
      - wput
      - wrk
      - x11-xkb-utils
      - x11-xserver-utils
      - xclip
      - xdg-user-dirs
      - xorg
      - xsel
      - xserver-xorg-input-kbd
      - xserver-xorg-input-libinput
      - xserver-xorg-input-synaptics
      - yarnpkg

  - name: check built-in tools
    shell: command -v {{item}}
    with_items:
    - getconf
    - ipcs
    - losetup
    - lscpu
    - lsusb
    - pmap
    - trap

  - name: install ocaml packages
    apt:
      install_recommends: no
      autoclean: yes
      name:
      - menhir
      - ocaml
      - opam

  - name: install python packages
    apt:
      install_recommends: no
      autoclean: yes
      name:
      - pylint
      - yapf

  - name: remove apt packages
    apt:
      state: absent
      autoremove: yes
      purge: yes
      name:
      - apport
      - blueman
      - gnome-keyring
      - lightdm
      - mate-applets
      - mate-power-manager
      - mate-screensaver
      - mate-user-guide
      - mate-utils
      - mate-utils-common
      - nm-tray
      - packagekit
      - snapd
      - system-config-printer
      - update-notifier
      - usbmuxd
      - whoopsie
      - xscreensaver

  - name: install npm
    shell: "command -v npm || apt install npm"

  - name: install npm packages
    shell: "npm -g install {{item}}"
    with_items:
    - http-proxy-to-socks
    - object-path-cli

  - name: download gradle
    unarchive:
      src: https://downloads.gradle.org/distributions/gradle-3.5.1-bin.zip
      dest: /usr/local/lib
      remote_src: yes
    when: false

  - name: download pt-summary
    get_url: url=http://percona.com/get/pt-summary dest=/usr/bin/pt-summary mode=0755

  - name: remove default font config
    file: dest=/etc/fonts/conf.d state=absent

  - name: create etc directories
    file: dest=/{{item}} state=directory recurse=yes
    with_items:
    - etc/X11/xorg.conf.d
    - etc/apt/apt.conf.d
    - etc/fonts/conf.d
    - etc/security/limits.d
    - etc/supervisor/conf.d
    - etc/xdg/awesome

  - name: create symbolic link to global config
    file: src=/home/{{user}}/.sysconf/{{item}} dest=/{{item}} state=link force=yes
    with_items:
    - etc/X11/xorg.conf.d/99-synaptics.conf
    - etc/apt/apt.conf.d/99default
    - etc/fonts/conf.d/99-default.conf
    - etc/rc.local
    - etc/xdg/awesome/rc.lua

  - name: create template config
    template: src={{item}}.tpl dest=/{{item}} mode=0440
    with_items:
    - etc/security/limits.d/default.conf
    - etc/sudoers.d/default
    - etc/supervisor/conf.d/ss-local.conf
    - etc/supervisor/conf.d/unix_http_server.conf

  - name: remove font dir
    lineinfile:
      dest: /etc/fonts/fonts.conf
      regexp: '^\s{0,}<dir'
      state: absent

  - name: add font dir
    lineinfile:
      dest: /etc/fonts/fonts.conf
      line: "\t{{item}}"
      insertafter: '<fontconfig'
    with_items:
    - '<dir>~/.fonts</dir>'
    - '<dir>/usr/share/fonts</dir>'

  - name: update tsocks config
    lineinfile:
      dest: /etc/tsocks.conf
      regexp: '^server\s{0,}='
      line: 'server = 127.0.0.1'

  - name: disable splash screen and fix Ryzen CPU
    lineinfile:
      dest: /etc/default/grub
      regexp: '^GRUB_CMDLINE_LINUX_DEFAULT\s{0,}='
      line: 'GRUB_CMDLINE_LINUX_DEFAULT="idle=nomwait"'

  - name: update grub config
    command: update-grub2

  - name: update systemd logind.conf
    lineinfile:
      dest: /etc/systemd/logind.conf
      regexp: '^{{item.key}}\s{0,}='
      line: '{{item.key}}={{item.value}}'
    with_items:
    - { key: "HandleLidSwitch", value: "ignore" }
    - { key: "HandlePowerKey", value: "suspend" }

  - name: increase max_user_watches
    lineinfile:
      dest: /etc/sysctl.conf
      regexp: '^fs.inotify.max_user_watches\s{0,}='
      line: 'fs.inotify.max_user_watches=524288'

  - name: update max_user_watches
    command: sysctl -p

  - name: create user directories
    file: dest=/home/{{user}}/{{item}} state=directory recurse=yes owner={{user}}
    with_items:
    - .config/Code/User
    - .ssh

  - name: create symbolic link to user config
    file: src=/home/{{user}}/.sysconf/dotfiles/{{item}} dest=/home/{{user}}/.{{item}} state=link force=yes owner={{user}}
    with_items:
    - Xdefaults
    - bashrc
    - config/Code/User/keybindings.json
    - config/Code/User/settings.json
    - gitconfig
    - ssh/config
    - tmux.conf
    - vimrc
    - xinitrc

  - name: install vscode extensions
    shell: "code --install-extension {{item}}"
    with_items:
    - freebroccolo.reasonml
    - henriiik.vscode-sort
    - michelemelluso.code-beautifier
    - mikeburgh.xml-format
    - ms-python.python
    - octref.vetur
    - tobiasalthoff.atom-material-theme
    - vscodevim.vim
    become: true
    become_user: "{{user}}"
